## 项目目录结构设计与渐进式开发指南

### 概述

本指南基于当前项目的技术栈与实际代码，提供一套符合渐进式开发原则的目录结构方案，并对每个目录的职责、内容类型与依赖关系进行说明，帮助团队在可扩展性、模块化与易维护性方面达成一致。

- 技术栈：Next.js 15.5.6、React 19、TypeScript（严格模式）、Tailwind CSS 4.x、GSAP、App Router（`src/app`）
- 现有模块：`autumn-my` 工具页面及其组件与 Hooks（例如 `useSectionScroll`、`useStaggerIn`、`useLeafFall`）、集中类型 `types/polaroid`
- 配置：`next.config.ts`（含图片远程加载与 qualities）、ESLint、Prettier、`tsconfig.json`、环境变量（`.env.local`）

---

### 树状目录结构图

```text
amtool/
├── src/
│  ├── app/                       # App Router 页面与路由（Next.js 官方约定）
│  │  ├── layout.tsx             # 根布局
│  │  ├── page.tsx               # 首页
│  │  └── tools/                 # 业务工具集合（如 autumn-my）
│  │     ├── autumn-my/
│  │     │  ├── page.tsx
│  │     │  ├── components/      # 该页面的专属组件
│  │     │  ├── hooks/           # 该页面的专属 Hooks（如 useSectionScroll）
│  │     │  └── types/           # 该页面的专属类型（如 polaroid）
│  ├── components/               # 公共可复用组件（页面无关）
│  │  ├── ui/                    # 基础 UI（Button、Card、Modal 等）
│  │  ├── forms/                 # 表单类组件（Input、Select 等）
│  │  └── layouts/               # 布局类组件（Header、Footer、Grid 等）
│  ├── hooks/                    # 公共 Hooks（跨页面复用）
│  ├── lib/                      # 业务逻辑与工具库（数据处理、动画封装、配置）
│  ├── types/                    # 全局类型定义（共享接口、枚举、常量）
│  ├── styles/                   # 样式文件（全局样式、CSS Modules）
│  └── utils/                    # 工具函数（日期、字符串、校验等）
├── public/                      # 静态资源（图标、开放图片、manifest）
├── tests/                       # 测试目录
│  ├── unit/                     # 单元测试（ts/tsx）
│  └── e2e/                      # 端到端测试（Playwright）
├── docs/                        # 文档目录（架构、规范、设计方案）
├── config/                      # 工具链与运行配置（集中化管理）
│  ├── eslint/                   # ESLint 配置片段与规则
│  ├── prettier/                 # Prettier 配置片段
│  ├── tailwind/                 # Tailwind 配置与预设
│  └── next/                     # Next.js 相关配置说明与模板
├── .trae/                       # 团队内规范与实施计划（现有）
├── next.config.ts               # Next 实际配置文件（位于根）
├── tailwind.config.ts           # Tailwind 实际配置文件（根）
├── tsconfig.json                # TypeScript 配置
├── .eslintrc.cjs                # ESLint 配置
├── .prettierrc                  # Prettier 配置
├── .env.local                   # 本地开发环境变量
└── vercel.json                  # 部署相关
```

---

### 节点详细说明

#### 1. `src/app/`
- 存放内容：页面文件、路由与布局（Next.js App Router）。
- 项目角色：路由入口与页面渲染层，协调组件与业务逻辑。
- 依赖关系：依赖 `src/components`（UI）、`src/hooks`（行为）、`src/lib`（逻辑）、`src/types`（类型）。

#### 2. `src/components/`
- 存放内容：公共可复用组件（页面无关）。
- 项目角色：标准化 UI 能力，提升复用率与一致性。
- 依赖关系：可依赖 `src/hooks`、`src/lib` 与 `src/types`，禁止反向依赖页面。

#### 3. `src/hooks/`
- 存放内容：公共 Hooks（如动画、滚动、可达性、状态管理）。
- 项目角色：抽象副作用与交互行为，统一依赖入口。
- 依赖关系：可依赖 `src/lib` 与 `src/types`，避免依赖具体页面组件。

#### 4. `src/lib/`
- 存放内容：核心业务逻辑、工具库与配置封装（例如动画封装、数据处理、常量）。
- 项目角色：领域逻辑与跨模块工具的统一归档；保证可测试性。
- 依赖关系：仅依赖 `src/types` 与标准库；被 `hooks/components/pages` 依赖。

#### 5. `src/types/`
- 存放内容：共享类型、枚举、常量（例如 `CardStyle`、API 响应类型）。
- 项目角色：全局类型契约，保证模块间的类型安全。
- 依赖关系：零依赖（理想状态），被所有上层模块引用。

#### 6. `src/styles/`
- 存放内容：全局样式（`globals.css`）、CSS Modules 与主题。
- 项目角色：样式与主题的集中化管理。
- 依赖关系：被页面与组件引用，不依赖逻辑层。

#### 7. `src/utils/`
- 存放内容：与业务弱相关的纯工具函数（`formatDate`、`clamp` 等）。
- 项目角色：通用工具集合，优先保持无副作用与可测试性。
- 依赖关系：零或低依赖，被上层模块引用。

#### 8. `public/`
- 存放内容：公开静态资源（favicon、manifest、开放图片等）。
- 项目角色：供 Next 直接服务的静态资源路径。
- 依赖关系：被页面与组件引用；注意与远程图片加载策略统一。

#### 9. `tests/`
- 存放内容：单元测试与端到端测试。
- 项目角色：质量保障与回归验证。
- 依赖关系：
  - `unit/` 依赖 `lib/hooks/components` 的导出 API。
  - `e2e/` 通过 Playwright 对页面进行端到端验证。

#### 10. `docs/`
- 存放内容：架构说明、设计方案与规范文档（本文件归属此目录）。
- 项目角色：知识沉淀与团队协作基线。
- 依赖关系：引用代码示例与结构，但不参与构建。

#### 11. `config/`
- 存放内容：工具链与运行配置的说明与预设（集中化文档与模板）。
- 项目角色：配置管理与团队约定同步；实际生效文件位于项目根。
- 依赖关系：无构建参与；被团队成员参考与复用。

#### 12. 根配置文件
- `next.config.ts`：Next.js 配置（图片 qualities、远程来源、性能优化）。
- `tailwind.config.ts`：Tailwind 设计系统配置。
- `.eslintrc.cjs` / `.prettierrc`：规范与格式统一。
- `tsconfig.json`：类型系统严格模式与路径别名设置。
- `.env.local`：本地环境变量（`NEXT_PUBLIC_` 前缀的暴露策略）。

---

### 模块依赖关系图（ASCII）

```text
[ pages (src/app/*) ]
        │  imports
        ▼
[ components (src/components/*) ]  ◀── uses ── [ hooks (src/hooks/*) ]
        │                                  │
        │ uses                             │ uses
        ▼                                  ▼
[ lib (src/lib/*) ] ──── uses ──── [ types (src/types/*) ]
        │
        ▼
[ utils (src/utils/*) ]

[ public/* ]  → next/image / assets
[ tests/* ]   → unit/e2e validate above modules
[ config/* ]  → documents & presets (root configs take effect)
```

---

### 渐进式开发路线建议

1. 基线搭建（结构与规范）
   - 建立 `src/components/ui` 与 `src/hooks` 的复用基线（Button、Modal、usePressFeedback）。
   - 在 `src/types` 统一导出跨模块类型（如 `CardStyle`、`ViewportSize`）。
   - Tailwind 与 ESLint/Prettier 在根配置，`config/*` 提供团队说明与预设。

2. 业务抽象（从页面内聚到跨页面）
   - 将页面内的专属 Hooks（如 `useSectionScroll`）抽象通用参数后迁移到 `src/hooks`，提升跨页面复用。
   - 动画逻辑在 `src/lib/animation.ts` 归档，组件通过 Hooks 或直接调用。

3. 资源策略与性能优化
   - 统一图片策略：`next.config.ts` 的 `images.remotePatterns` 与 `qualities` 保持与组件质量参数一致。
   - 在移动端使用 `100svh + visualViewport.height` 锁定单屏高度，滚动使用 `gsap.to` 与 `overscroll-behavior` 防溢出。

4. 测试护栏
   - `tests/unit/` 为 `lib` 与 `hooks` 建立单测（行为与边界条件）。
   - `tests/e2e/` 编写关键路径用例（切屏滚动、图片查看器、响应式布局）。

5. 文档与规范持续化
   - 在 `docs/` 维护架构演进、组件规范与场景案例，确保新成员可快速上手。

---

### 代码示例（与技术栈一致）

```tsx
// 示例：统一的按压反馈 Hook（可放入 src/hooks/usePressFeedback.ts）
// 这个 Hook 为可点击元素添加按压动画反馈，提升交互体验
import { useEffect } from "react";
import gsap from "gsap";

export function usePressFeedback(ref: React.RefObject<HTMLElement>) {
  // 绑定指针事件并使用 GSAP 实现缩放动画
  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    const down = () => gsap.to(el, { scale: 0.97, duration: 0.1, ease: "power2.out" });
    const up = () => gsap.to(el, { scale: 1, duration: 0.15, ease: "power2.out" });
    el.addEventListener("pointerdown", down);
    el.addEventListener("pointerup", up);
    el.addEventListener("pointerleave", up);
    return () => {
      el.removeEventListener("pointerdown", down);
      el.removeEventListener("pointerup", up);
      el.removeEventListener("pointerleave", up);
    };
  }, [ref]);
}
```

```tsx
// 示例：在页面使用统一滚动逻辑（src/app/tools/autumn-my/page.tsx）
// 通过 visualViewport.height 锁定单屏高度，确保滚动不溢出且状态与渲染同步
import { useRef, useState } from "react";
import { useSectionScroll } from "./hooks/useSectionScroll";

export default function Page() {
  const containerRef = useRef<HTMLDivElement>(null);
  const wrapperRef = useRef<HTMLDivElement>(null);
  const animatingRef = useRef(false);
  const [activeIndex, setActiveIndex] = useState(0);
  useSectionScroll({ activeIndex, onIndexChange: setActiveIndex, animatingRef, containerRef, wrapperRef });
  return (
    <main ref={containerRef} style={{ height: "100svh", overscrollBehavior: "none", touchAction: "none" }}>
      <div ref={wrapperRef}>{/* 每屏内容 */}</div>
    </main>
  );
}
```

```ts
// 示例：单元测试（tests/unit/viewport.spec.ts）
// 这个测试验证视口高度计算逻辑的健壮性
import { describe, it, expect } from "vitest";

function computeViewportHeight(win: { innerHeight: number; visualViewport?: { height: number } }) {
  // 优先使用 visualViewport.height，兼容部分移动端浏览器
  return win.visualViewport?.height ?? win.innerHeight;
}

describe("computeViewportHeight", () => {
  it("falls back to innerHeight when visualViewport missing", () => {
    expect(computeViewportHeight({ innerHeight: 800 })).toBe(800);
  });
  it("uses visualViewport.height when available", () => {
    expect(computeViewportHeight({ innerHeight: 800, visualViewport: { height: 720 } })).toBe(720);
  });
});
```

---

### 总结

该目录结构遵循行业最佳实践与 Next.js 官方约定，通过“页面 → 组件/Hooks → 逻辑库/类型”的层次化组织，确保模块化、可扩展与易维护。配合渐进式路线与测试护栏，可以平滑地引入新功能，同时保持架构稳定与性能可靠。

---

## 内容优化与改进建议

### 已识别的可优化点
- 配置目录的职责可再明确：根层配置是生效源，`config/` 建议只存放说明与模板，避免与根配置混淆。
- 路径别名未在指南中落地：建议统一 `@` 别名，减少相对路径复杂度。
- 测试方案需可执行示例：当前使用 Vitest 示例，建议结合 Playwright e2e，并在后续补充 Jest/Vitest 的选择与安装指引。
- 命名与约束可再强调：对组件命名（PascalCase）、工具函数（camelCase）、样式（kebab-case）在文档中明确落地。
- 移动端单屏滚动策略应沉淀：将 `visualViewport.height + 100svh` 的做法与溢出防止作为统一规范。

### 路径别名与导入规范（新增）

```jsonc
// tsconfig.json 片段示例：统一使用 @ 别名
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@components/*": ["src/components/*"],
      "@hooks/*": ["src/hooks/*"],
      "@lib/*": ["src/lib/*"],
      "@types/*": ["src/types/*"],
      "@utils/*": ["src/utils/*"]
    }
  }
}
```

### 命名规范与模块边界（新增）
- 组件：`PascalCase`（如 `UserCard.tsx`），文件与导出保持一致命名，默认使用命名导出。
- 工具函数：`camelCase`（如 `formatDate.ts`），尽量纯函数、无副作用。
- 样式：`kebab-case`（如 `user-card.module.css`），Tailwind 原子类优先，CSS Modules 辅助。
- 依赖边界：页面不直接依赖另一个页面；公共模块不依赖具体页面；`lib` 仅依赖 `types` 与标准库。

### 统一移动端单屏滚动策略（新增）
- 规范：主容器统一 `style={ height: '100svh', overscrollBehavior: 'none', touchAction: 'none' }`。
- 视口高度：统一在行为层读取 `visualViewport.height`（存在时优先）。
- 同步逻辑：在 `resize` 与 `orientationchange` 时重算位置，防止地址栏出现/隐藏导致内容错位。
- 防溢出：动画期间拦截 `touchmove`，并在滚动切屏结束后恢复状态。

### 测试方案落地（新增）
- 单元测试：建议使用 Vitest（或 Jest）针对 `lib` 与 `hooks` 做行为与边界测试。
- e2e 测试：使用 Playwright 覆盖关键路径（切屏滚动、图片查看器、响应式断点）。
- 目录：`tests/unit/*` 与 `tests/e2e/*`，并在 CI 集成基础用例。

### 配置目录与根配置协作（新增）
- 根配置生效：`next.config.ts`、`tailwind.config.ts`、`.eslintrc.cjs`、`.prettierrc`、`tsconfig.json`。
- `config/` 目录：仅存放对应配置的说明、模板与团队约束（避免重复配置）。
- 图片策略：在根层 `images.remotePatterns` 与 `qualities` 与组件使用的 `quality` 值保持一致。

### 渐进式演进里程碑（强化）
1. 基线（第 0 周）：路径别名统一、配置模板落地、公共 UI 与 Hooks 基线建立。
2. 抽象（第 1–2 周）：页面内专属 Hooks 参数化后迁至 `src/hooks`，动画封装沉淀至 `src/lib/animation.ts`。
3. 测试（第 2–3 周）：为核心逻辑补齐 `unit` 测试与关键路径 `e2e`；完善 CI 脚本。
4. 文档（持续）：在 `docs/` 维护架构演进记录与场景规范，配合 code review 进行更新。