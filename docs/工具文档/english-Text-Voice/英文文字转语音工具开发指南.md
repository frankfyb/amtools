# 英文文字转语音工具开发指南

## 一、项目概述

### 1.1 工具简介
基于 Next.js 14+ 开发的英文文字转语音工具，集成谷歌免费 TTS API，提供高质量的英文语音合成服务。

### 1.2 技术架构
- **框架**: Next.js 14+ (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **部署**: Vercel

### 1.3 目录结构
```
src/app/tools/english-text-voice/
├── page.tsx                    # 客户端组件（主界面）
└── api/
    └── tts/
        ├── route.ts           # API路由（GET/POST）
        └── test.md           # API测试文档
```

## 二、核心功能实现

### 2.1 客户端组件 (page.tsx)

#### 2.1.1 状态管理
使用 React Hooks 管理应用状态：
```typescript
// 主要状态
const [text, setText] = useState('')
const [audioUrl, setAudioUrl] = useState('')
const [isLoading, setIsLoading] = useState(false)
const [error, setError] = useState('')
const [progress, setProgress] = useState(0)
const [duration, setDuration] = useState(0)

// 语音配置
const [voice, setVoice] = useState('en-US-Standard-A')
const [speed, setSpeed] = useState(1.0)
const [pitch, setPitch] = useState(1.0)
const [volume, setVolume] = useState(1.0)
```

#### 2.1.2 语音选项配置
支持6种英文语音类型：
- `en-US-Standard-A` (女声)
- `en-US-Standard-B` (男声)
- `en-US-Standard-C` (女声)
- `en-US-Standard-D` (男声)
- `en-GB-Standard-A` (英式女声)
- `en-GB-Standard-B` (英式男声)

#### 2.1.3 核心功能函数

**文本处理与验证**
```typescript
const handleTextChange = useCallback((value: string) => {
  setText(value)
  if (value.length > 5000) {
    setError('文本长度不能超过5000字符')
  } else {
    setError('')
  }
}, [])
```

**音频生成**
```typescript
const generateSpeech = async () => {
  if (!text.trim()) {
    setError('请输入要转换的文本')
    return
  }
  
  setIsLoading(true)
  setError('')
  
  try {
    const audioUrl = await createRealAudioUrl(text, speed)
    setAudioUrl(audioUrl)
    // 估算音频时长
    const estimatedDuration = estimateAudioDuration(text, speed)
    setDuration(estimatedDuration)
  } catch (error) {
    setError('语音生成失败，请重试')
  } finally {
    setIsLoading(false)
  }
}
```

**双重音频生成机制**
```typescript
const createRealAudioUrl = async (text: string, speed: number) => {
  try {
    // 主要方案：调用谷歌TTS API
    const response = await fetch('/tools/english-text-voice/api/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, speed })
    })
    
    if (response.ok) {
      const blob = await response.blob()
      return URL.createObjectURL(blob)
    }
  } catch (error) {
    console.error('TTS API调用失败:', error)
  }
  
  // 备用方案：生成简单音频文件
  return createFallbackAudio()
}
```

### 2.2 API路由实现 (route.ts)

#### 2.2.1 GET方法
```typescript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const text = searchParams.get('text')
  const speed = parseFloat(searchParams.get('speed') || '1.0')
  
  if (!text) {
    return new Response('Missing text parameter', { status: 400 })
  }
  
  return await callGoogleTTS(text, speed)
}
```

#### 2.2.2 POST方法
```typescript
export async function POST(request: Request) {
  try {
    const { text, speed = 1.0 } = await request.json()
    
    if (!text) {
      return new Response('Missing text parameter', { status: 400 })
    }
    
    return await callGoogleTTS(text, speed)
  } catch (error) {
    return new Response('Invalid JSON', { status: 400 })
  }
}
```

#### 2.2.3 谷歌TTS集成
```typescript
async function callGoogleTTS(text: string, speed: number) {
  // 长文本分块处理
  if (text.length > 300) {
    const chunks = splitTextIntoChunks(text, 300)
    const audioChunks = []
    
    for (const chunk of chunks) {
      const response = await fetchGoogleTTS(chunk, speed)
      audioChunks.push(response)
    }
    
    // 合并音频块
    return mergeAudioChunks(audioChunks)
  }
  
  return await fetchGoogleTTS(text, speed)
}
```

## 三、开发环境配置

### 3.1 项目初始化
```bash
# 克隆项目
git clone <repository-url>
cd amtool

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 3.2 环境变量配置
创建 `.env.local` 文件（如需要）：
```env
# 当前项目使用免费API，无需配置密钥
# GOOGLE_TTS_API_KEY=your_api_key_here
```

### 3.3 开发调试
- 访问 `http://localhost:3000/tools/english-text-voice`
- 使用浏览器开发者工具查看网络请求
- 检查 `/api/tts` 接口响应

## 四、核心技术要点

### 4.1 文本处理
- **字符限制**: 最大5000字符
- **分块处理**: 超过300字符自动分块
- **智能分割**: 按句号、问号、感叹号分割

### 4.2 音频处理
- **格式**: MP3
- **质量**: 128kbps
- **缓存**: 内存LRU缓存（10分钟）
- **下载**: Blob URL机制

### 4.3 用户体验优化
- **防抖处理**: 文本输入防抖500ms
- **加载状态**: 按钮禁用+加载动画
- **错误处理**: 友好的错误提示
- **进度反馈**: 实时进度更新

### 4.4 性能优化
- **缓存策略**: API响应缓存
- **懒加载**: 音频按需加载
- **内存管理**: 及时释放Blob URL

## 五、测试与调试

### 5.1 功能测试
1. **基础功能**
   - 文本输入与验证
   - 语音参数调节
   - 音频生成与播放

2. **边界测试**
   - 空文本处理
   - 超长文本处理
   - 网络异常处理

3. **兼容性测试**
   - Chrome、Edge、Safari
   - 移动端浏览器

### 5.2 API测试
使用 `api/tts/test.md` 中的测试用例：
```bash
# GET请求测试
curl "http://localhost:3000/tools/english-text-voice/api/tts?text=Hello%20World&speed=1.0"

# POST请求测试
curl -X POST http://localhost:3000/tools/english-text-voice/api/tts \
  -H "Content-Type: application/json" \
  -d '{"text":"Hello World","speed":1.0}'
```

## 六、部署指南

### 6.1 Vercel部署
```bash
# 安装Vercel CLI
npm i -g vercel

# 部署到Vercel
vercel --prod
```

### 6.2 构建优化
```bash
# 本地构建测试
npm run build
npm run start
```

### 6.3 性能监控
- 使用Lighthouse检测性能
- 监控API响应时间
- 检查内存使用情况

## 七、常见问题与解决方案

### 7.1 音频生成失败
**问题**: TTS API调用失败
**解决**: 检查网络连接，使用备用音频生成机制

### 7.2 长文本处理
**问题**: 超长文本转换慢
**解决**: 自动分块处理，并行请求优化

### 7.3 浏览器兼容性
**问题**: 某些浏览器不支持特定功能
**解决**: 特性检测，提供降级方案

### 7.4 内存泄漏
**问题**: 长时间使用内存增长
**解决**: 及时释放Blob URL，清理音频对象

## 八、扩展开发

### 8.1 新增语音类型
1. 在语音选项中添加新的voice ID
2. 更新API路由支持新语音
3. 测试新语音的兼容性

### 8.2 音频格式支持
1. 修改API返回格式
2. 更新客户端音频处理
3. 适配下载功能

### 8.3 批量处理功能
1. 设计批量上传界面
2. 实现队列处理机制
3. 添加进度跟踪

---

> 本文档基于实际实现编写，如有疑问请参考源代码或联系开发团队。