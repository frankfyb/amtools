# 授权控制策略（受限路由与访问控制）

## 学习目标
- 理解认证（谁）与授权（能做什么）的区别；掌握受限路由保护与扩展策略。

## 当前实现
- 路由级授权：使用 NextAuth 中间件保护 `/back/:path*`，仅允许已登录用户访问。
- 页面内授权：组件级别根据 `session` 判断是否展示某些操作入口（例如提交按钮、管理入口等）。

## 扩展策略
- 角色与权限：在 `session.user` 增加 `role` 字段；在页面/组件检查 `role` 决定可见性与操作能力。
- 后端接口授权：API 端点通过 `getServerSession(authOptions)` 校验并鉴权。
- 细粒度控制：
  - 路由：将更多路径加入 `config.matcher`。
  - 组件：封装 `Can` 组件，接收 `permission` 与 `session`，决定是否渲染 children。

## 示例
- 中间件 matcher 扩展：
```ts
export const config = { matcher: ['/back/:path*', '/tools/:path*'] };
```

- 组件级授权：
```tsx
function Can({ needRole, children }: { needRole: 'admin' | 'user'; children: React.ReactNode }) {
  const { data: session } = useSession();
  if (!session) return null;
  const role = (session.user as any)?.role ?? 'user';
  return role === needRole ? <>{children}</> : null;
}
```

## 安全建议
- 授权判断不可只在前端完成；关键资源的校验必须在服务端/API 层重复验证。
- 避免开放式重定向：回跳地址应限定在同站域名内或白名单。

## 练习建议
- 在 `authOptions.callbacks.session` 中添加 `role` 并前端渲染不同菜单。
- 为某个 API 添加服务端授权校验，非授权请求返回 403。