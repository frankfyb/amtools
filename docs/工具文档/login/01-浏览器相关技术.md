# 浏览器相关技术（与本项目登录/认证实现关联）

## 学习目标
- 了解 DOM/BOM、事件、存储与 Cookie、URL 与导航、网络与安全（CORS/CSP）。
- 掌握在登录/退出流程中如何通过 URL 查询参数进行一次性提示与回跳。
- 理解 NextAuth 中间件如何基于浏览器 Cookie 在受限路由上执行重定向。

## 关键知识点
- DOM 与事件：`click`/`submit` 事件处理、阻止默认行为、键盘/鼠标事件。
- BOM 与导航：`window.location`、`history.pushState/replaceState`、`URL`/`URLSearchParams`。
- Web 存储：`localStorage`（持久）与 `sessionStorage`（会话），适合保存轻量 UI 状态。
- Cookie 概览：`Secure`、`HttpOnly`、`SameSite` 属性。前端无法读 `HttpOnly` Cookie；认证通常依赖服务端设置与校验。
- 网络与安全：
  - CORS：跨域请求需服务端允许；Next.js API 默认同源无需额外配置。
  - CSP：约束页面可执行的脚本来源，提高安全性（生产环境建议开启）。
- SSR 与 CSR：Next.js App Router 同时存在服务端渲染与客户端组件；认证提示与交互多在客户端完成。

## 与本项目的关联点
- 一次性提示：登录/退出后在 URL 附带 `?login=ok` 或 `?logout=ok`，组件读取后显示提示并用 `replace` 清理参数。
- 回跳机制：通过 `callbackUrl` 或自定义 `from` 参数，登录成功后返回来源页。
- 受限路由重定向：`src/middleware.ts` 使用 NextAuth 中间件检查会话（基于 Cookie），未登录访问 `/back/*` 会被重定向到登录页。

## 示例代码
读取并清理一次性提示参数：
```ts
// 在客户端组件中
import { useSearchParams, useRouter } from 'next/navigation';

function useOneTimeBanner() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const loginOk = searchParams.get('login') === 'ok';
  const logoutOk = searchParams.get('logout') === 'ok';

  function clearBannerParams() {
    const url = new URL(window.location.href);
    url.searchParams.delete('login');
    url.searchParams.delete('logout');
    router.replace(url.pathname + url.search);
  }

  return { loginOk, logoutOk, clearBannerParams };
}
```

构造安全的回跳地址：
```ts
const base = typeof window !== 'undefined' ? window.location.origin : process.env.NEXT_PUBLIC_BASE_URL;
const target = new URL(callbackUrl ?? '/', base);
// 附加一次性提示参数
const redirectUrl = `${target.pathname}${target.search}${target.search ? '&' : '?'}login=ok`;
```

## 常见问题与排查
- 登录后提示未显示：检查是否在回跳 URL 上附加 `login=ok`；或组件是否正确解析查询参数。
- 回跳地址错误：避免直接拼字符串，使用 `new URL` 构造，保留原有查询参数。
- 中间件未生效：确认 `src/middleware.ts` 的 `config.matcher` 包含目标受限路径；本项目为 `['/back/:path*']`。

## 学习与检查清单
- 能用 `URLSearchParams` 获取并清理查询参数。
- 知道 Cookie 的 `HttpOnly` 无法被前端读取，认证判断交给服务端/中间件。
- 能解释 CORS 何时需要、如何影响前端请求（同源下通常无感）。