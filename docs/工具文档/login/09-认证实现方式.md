# 认证实现方式（NextAuth 集成与流程）

## 学习目标
- 了解 Credentials/OAuth 两种登录方式的实现，掌握会话管理与提示交互。

## 体系概览
- NextAuth 作为认证框架，负责：
  - 提供商（Providers）：Credentials、GitHub、Google。
  - 会话管理：JWT 或数据库存储（本项目为 JWT）。
  - 中间件：受限路由重定向。
- PrismaAdapter：将用户/会话持久化到数据库（便于扩展更复杂场景）。

## 项目内文件与职责
- `src/app/api/auth/[...nextauth]/route.ts`：配置提供商与回调；为 `getServerSession` 暴露 `authOptions`。
- `src/app/providers.tsx`：用 `SessionProvider` 包裹 App，客户端组件可 `useSession`。
- `src/middleware.ts`：基于 NextAuth 中间件保护 `/back/:path*`。
- `src/app/utils/authService.ts`：封装登录、退出、显示名与一次性提示解析。
- `src/app/components/AuthStatus.tsx`：全局认证入口与用户菜单。
- `src/app/(auth)/login/page.tsx`：登录页面，处理表单/OAuth、错误提示与回跳。

## 流程说明
1. 未登录访问 `/back`：中间件重定向到 `/login?callbackUrl=/back`。
2. 登录页提交：
   - 凭证登录：`signIn('credentials', { redirect: false, ... })`；成功后 `router.replace(callbackUrl + '?login=ok')`。
   - OAuth 登录：`signIn('github', { callbackUrl })`；由 NextAuth 完成跳转，成功后回到来源页。
3. 成功提示：`AuthStatus` 解析 URL 的 `login=ok` 或 `logout=ok`，显示一次性提示并清理参数。
4. 退出登录：`signOut({ callbackUrl: '/?logout=ok' })`；回首页提示退出成功。

## 错误处理与映射
- `next-auth` 错误码（如 `OAuthAccountNotLinked`、`AccessDenied`）在登录页用映射函数转为友好文案。

## 安全要点
- 使用 `redirect: false` 手动控制前端跳转与错误提示。
- 校验并构造合法的 `callbackUrl`，避免开放式重定向风险。
- 生产环境 Cookie 建议：`Secure`、`HttpOnly`、`SameSite=Lax`。

## 练习建议
- 扩展错误映射函数，覆盖更多 NextAuth 错误场景。
- 在 `authService` 中统一构造回跳 URL，避免重复代码。