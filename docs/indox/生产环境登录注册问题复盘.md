## 概述
- 目标：修复生产站点 `https://amtools.top/login` 登录报错，确保登录/注册功能稳定。
- 栈与环境：Next.js App Router、NextAuth、Prisma、Supabase Postgres（PgBouncer 6543 / 直连 5432）、Vercel。

## 症状与错误
- 浏览器报错：Invalid `prisma.user.findFirst()` invocation。
- Prisma 校验错误：`Environment variable not found: DATABASE_URL`（`prisma/schema.prisma:8`）。
- 在 PgBouncer 端口（6543）执行迁移时出现：`prepared statement "s1" already exists`。

## 根因分析
- 登录逻辑依赖 Prisma 查询用户（`src/app/api/auth/[...nextauth]/route.ts:27-36`），运行时数据源解析失败导致查询失败。
- Supabase 的 PgBouncer（6543）不支持 Prisma Migrate 所需的 prepared statements，易触发冲突。
- 生产环境中 `DATABASE_URL` 未被正确提供或解析，Prisma 按 `schema.prisma:6-9` 读取 `env("DATABASE_URL")` 时失败。

## 关键改动
- `.env` 同时配置池化与直连连接：
  - `DATABASE_URL="postgresql://...aws-1-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require"`（运行时）
  - `DIRECT_URL="postgresql://...aws-1-us-east-1.pooler.supabase.com:5432/postgres?sslmode=require"`（迁移/管理）
- `prisma/schema.prisma:6-9` 数据源块：
  - `datasource db { provider = "postgresql"; url = env("DATABASE_URL"); directUrl = env("DIRECT_URL") }`
- `prisma.config.ts:10-13`（迁移阶段使用直连）：
  - `datasource.url = env("DIRECT_URL")`
- 运行时客户端容错（`src/app/lib/prisma.ts:5-11`）：
  - 若 `DATABASE_URL` 缺失则回退到 `DIRECT_URL`：
  - `new PrismaClient({ datasources: { db: { url: process.env.DATABASE_URL ?? process.env.DIRECT_URL } } })`

## 执行与结果
- 验证 Schema：`npx prisma validate` 通过。
- 使用 5432 直连执行迁移：
  - 命令：`DIRECT_URL="...:5432/postgres?sslmode=require" npx prisma migrate dev --name init`
  - 结果：创建并应用迁移 `prisma/migrations/20251119075306_init/migration.sql`；Prisma Client 生成成功。
- 迁移内容：
  - 表：`User`、`Account`、`Session`、`VerificationToken`、`Todo`
  - 约束与索引：唯一索引（如 `User_email_key`）、外键级联（`Account.userId -> User.id`，`Session.userId -> User.id`）。

## 时间线（简要）
1. 初始生产错误：数据库不可达与变量缺失导致登录失败。
2. 增加诊断与检查：确认 PgBouncer 与迁移冲突；识别 `DATABASE_URL` 注入问题。
3. 切换迁移策略：迁移使用直连 5432；运行时用池化 6543。
4. 修复 `schema.prisma` 的 `url` 缺失错误（`P1012`），`generate` 成功。
5. 增强运行时容错：Prisma 客户端在 `DATABASE_URL` 缺失时自动使用 `DIRECT_URL`。

## 生产配置快照
- `.env:12-15`：池化（6543）与直连（5432）均已配置并含 `sslmode=require`。
- `prisma/schema.prisma:6-9`：数据源 `url/directUrl` 均启用，适配 CLI 与运行时。
- `prisma.config.ts:10-13`：迁移阶段使用直连，避免 PgBouncer 冲突。
- 登录查询位置：`src/app/api/auth/[...nextauth]/route.ts:27-36`
- 客户端容错位置：`src/app/lib/prisma.ts:5-11`

## 经验与最佳实践
- Prisma Migrate 与 PgBouncer 不兼容：迁移必须使用直连（5432），运行时采用池化（6543）。
- 当引入 `prisma.config.ts` 时，Prisma CLI会跳过自动加载 `.env`，需在配置文件显式 `import "dotenv/config"` 并用 `env(...)` 提供值。
- 为关键环境变量增加运行时回退逻辑（如 `DIRECT_URL`）提高稳定性。
- 在 Vercel 设置 Production/Preview 环境变量，并避免手动设置 `NEXTAUTH_URL`（平台会自动注入）。

## 待办与建议
- 在 Vercel 控制台统一配置：`DATABASE_URL`（6543）、`DIRECT_URL`（5432）、`NEXTAUTH_SECRET`。
- 部署后访问 `/api/auth/production-diagnose` 验证环境与连接状态。
- 回归测试登录与注册：`/login`、`/register`。

## 参考位置
- `prisma/schema.prisma:6-9`
- `prisma.config.ts:10-13`
- `src/app/api/auth/[...nextauth]/route.ts:27-36`
- `src/app/lib/prisma.ts:5-11`
- `prisma/migrations/20251119075306_init/migration.sql`